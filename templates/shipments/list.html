{% extends "base.html" %}
{% load ui_extras %}
{% block head %}
  {{ block.super }}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
{% endblock %}
{% block title %}Shipment Tracking - Logistics Pro{% endblock %}
{% block content %}
<div class="flex h-full flex-col gap-6 p-6 lg:p-10">
  <nav class="text-xs font-medium text-gray-500 dark:text-gray-400">
    <a href="{% url 'dashboard' %}" class="hover:text-primary">Dashboard</a>
    <span class="mx-1 text-gray-400">/</span>
    <span class="text-text-light dark:text-text-dark">Shipments</span>
  </nav>

  <div class="flex flex-wrap items-center justify-between gap-4">
    <div class="flex min-w-72 flex-col gap-2">
      <h1 class="text-3xl font-bold tracking-tight text-text-light dark:text-text-dark">Shipment Tracking</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400">
        Monitor active and completed shipments in real-time.
      </p>
    </div>
    <a
      href="{% url 'shipments:create' %}"
      class="inline-flex h-10 items-center justify-center gap-2 rounded-lg bg-primary px-4 text-sm font-bold leading-normal tracking-[0.015em] text-white shadow-sm hover:bg-primary/90"
    >
      <span class="material-symbols-outlined text-[20px]">add</span>
      <span class="truncate">Create Shipment</span>
    </a>
  </div>

  <div class="grid flex-1 gap-6 lg:grid-cols-12">
    <!-- Sidebar list + filters -->
    <section class="space-y-4 lg:col-span-5 xl:col-span-4">
      <div class="rounded-2xl border border-border-light bg-card-light shadow-sm dark:border-border-dark dark:bg-card-dark">
        <div class="flex items-center justify-between border-b border-border-light px-4 py-3 dark:border-border-dark">
          <nav class="flex gap-2">
            <a
              href="{% url_with tab='active' id=None %}"
              class="rounded-lg px-3 py-2 text-sm font-semibold transition {% if current_tab == 'active' %}bg-primary text-white{% else %}text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10{% endif %}"
            >
              Active Shipments
              <span class="ml-1 rounded-full bg-white/20 px-1.5 text-[11px] font-bold text-white">{{ active_count }}</span>
            </a>
            <a
              href="{% url_with tab='completed' id=None %}"
              class="rounded-lg px-3 py-2 text-sm font-semibold transition {% if current_tab == 'completed' %}bg-primary text-white{% else %}text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10{% endif %}"
            >
              Completed Shipments
              <span class="ml-1 rounded-full bg-white/20 px-1.5 text-[11px] font-bold text-white">{{ completed_count }}</span>
            </a>
          </nav>
        </div>

        <form method="get" class="space-y-3 border-b border-border-light px-4 py-3 dark:border-border-dark">
          <input type="hidden" name="tab" value="{{ current_tab }}">
          <div class="flex items-center gap-2 rounded-xl border border-border-light bg-card-light px-3 py-2 text-sm text-gray-600 dark:border-border-dark dark:bg-card-dark dark:text-gray-300">
            <span class="material-symbols-outlined text-base">search</span>
            <input
              type="search"
              name="q"
              value="{{ search_query }}"
              placeholder="Search by shipment ID, customer, destination..."
              class="h-8 w-full border-none bg-transparent text-sm focus:outline-none focus:ring-0 dark:placeholder:text-gray-500"
            />
          </div>
          <div class="flex flex-wrap items-center gap-3 text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">
            <span class="flex items-center gap-2">
              <span class="material-symbols-outlined text-base">tune</span>
              Filters
            </span>
            <div class="flex flex-wrap gap-2 text-sm">
              <select name="status" class="h-9 rounded-lg border border-border-light bg-card-light px-3 text-sm text-text-light focus:outline-none focus:ring-2 focus:ring-primary/40 dark:border-border-dark dark:bg-card-dark dark:text-text-dark">
                {% for value,label in status_choices_current %}
                <option value="{{ value }}" {% if value == status_filter %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              <select name="priority" class="h-9 rounded-lg border border-border-light bg-card-light px-3 text-sm text-text-light focus:outline-none focus:ring-2 focus:ring-primary/40 dark:border-border-dark dark:bg-card-dark dark:text-text-dark">
                {% for value,label in priority_choices %}
                <option value="{{ value }}" {% if value == priority_filter %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              <select name="sort" class="h-9 rounded-lg border border-border-light bg-card-light px-3 text-sm text-text-light focus:outline-none focus:ring-2 focus:ring-primary/40 dark:border-border-dark dark:bg-card-dark dark:text-text-dark">
                {% for value,label in sort_choices %}
                <option value="{{ value }}" {% if value == sort_option %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <span class="ml-auto"></span>
            <button type="submit" class="inline-flex items-center gap-1 rounded-lg bg-primary px-3 py-2 text-xs font-semibold uppercase tracking-wide text-white">
              Apply
            </button>
            <a href="{% url_with status=None priority=None sort=None q=None id=None %}" class="text-xs font-semibold uppercase tracking-wide text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary">
              Reset
            </a>
          </div>
        </form>

        {% if quick_filters %}
        <div class="flex flex-wrap items-center gap-2 border-b border-border-light px-4 py-2 text-xs text-gray-500 dark:border-border-dark dark:text-gray-400">
          <span class="font-semibold uppercase tracking-wide">Quick filters:</span>
          {% for filter in quick_filters %}
          <a
            href="?{{ filter.query }}"
            class="inline-flex items-center rounded-full border border-border-light px-2.5 py-1 font-medium text-gray-600 transition hover:border-primary hover:text-primary dark:border-border-dark dark:text-gray-300 dark:hover:border-primary dark:hover:text-primary"
          >
            {{ filter.label }}
          </a>
          {% endfor %}
        </div>
        {% endif %}

        <div class="max-h-[60vh] overflow-y-auto divide-y divide-border-light dark:divide-border-dark">
          {% for s in shipments %}
          <a
            href="{% url_with id=s.id %}"
            class="block px-4 py-4 transition {% if selected and selected.id == s.id %}border-l-4 border-primary bg-primary/10 dark:bg-primary/20{% else %}hover:bg-gray-50 dark:hover:bg-white/5{% endif %}"
          >
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-2">
                <p class="text-sm font-semibold text-text-light dark:text-text-dark">ID: {{ s.tracking_id }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">{{ s.origin }} &rarr; {{ s.destination }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  ETA:
                  <span class="font-medium text-text-light dark:text-text-dark">
                    {{ s.eta|date:"M j, Y, g:i A"|default:"TBD" }}
                  </span>
                </p>
              </div>
              <div class="text-right space-y-1">
                <span
                  class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold
                    {% if s.status == 'in_transit' %}bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-200
                    {% elif s.status == 'delayed' %}bg-warning/20 text-warning dark:bg-warning/40 dark:text-warning
                    {% elif s.status == 'on_time' %}bg-success/20 text-success dark:bg-success/40 dark:text-success
                    {% elif s.status == 'issue' %}bg-danger/20 text-danger dark:bg-danger/40 dark:text-danger
                    {% else %}bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200{% endif %}"
                >
                  {{ s.get_status_display }}
                </span>
                <div class="text-[11px] font-semibold uppercase text-gray-400 dark:text-gray-500">
                  {{ s.get_priority_display }}
                </div>
              </div>
            </div>
          </a>
          {% empty %}
          <div class="px-4 py-6 text-center text-gray-500 dark:text-gray-400">
            No shipments match the current filters.
          </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- Detail panel -->
    <section class="lg:col-span-7 xl:col-span-8">
      {% if selected %}
      <div class="space-y-4">
        <div class="rounded-2xl border border-border-light bg-card-light p-6 shadow-sm dark:border-border-dark dark:bg-card-dark">
          <header class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <h3 class="text-lg font-bold text-text-light dark:text-text-dark">Shipment Details: {{ selected.tracking_id }}</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                Last updated {{ selected.last_updated|timesince }} ago
              </p>
            </div>
            <span class="inline-flex items-center rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold text-primary">
              {{ selected.get_status_display }}
            </span>
          </header>

          <div class="mt-6 grid gap-y-4 sm:grid-cols-2">
            <div>
              <p class="text-[11px] uppercase tracking-wide text-gray-400 dark:text-gray-500">Carrier</p>
              <p class="text-sm font-semibold text-text-light dark:text-text-dark">{{ selected.carrier|default:"—" }}</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-wide text-gray-400 dark:text-gray-500">Priority</p>
              <p class="text-sm font-semibold text-text-light dark:text-text-dark">{{ selected.get_priority_display }}</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-wide text-gray-400 dark:text-gray-500">Contents</p>
              <p class="text-sm font-semibold text-text-light dark:text-text-dark">{{ selected.contents|default:"—" }}</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-wide text-gray-400 dark:text-gray-500">Driver Contact</p>
              <p class="text-sm font-semibold text-text-light dark:text-text-dark">{{ selected.driver_contact|default:"—" }}</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-wide text-gray-400 dark:text-gray-500">Departure</p>
              <p class="text-sm text-gray-600 dark:text-gray-300">{{ selected.departure_time|date:"M j, Y, g:i A"|default:"TBD" }}</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-wide text-gray-400 dark:text-gray-500">ETA</p>
              <p class="text-sm text-gray-600 dark:text-gray-300">{{ selected.eta|date:"M j, Y, g:i A"|default:"TBD" }}</p>
            </div>
          </div>

          <div class="mt-6 grid gap-4 lg:grid-cols-2">
            <div class="rounded-lg border border-dashed border-border-light p-4 dark:border-border-dark">
              <p class="text-sm font-semibold text-text-light dark:text-text-dark">Route</p>
              <p class="text-sm text-gray-500 dark:text-gray-400">{{ selected.origin }} &rarr; {{ selected.destination }}</p>
            </div>
            <div class="rounded-lg border border-border-light bg-gray-100 p-2 dark:border-border-dark dark:bg-gray-800">
              <div id="shipment-map" class="h-[180px] w-full rounded-md"></div>
              <p class="mt-2 text-center text-xs text-gray-500 dark:text-gray-400">Simulated map powered by OpenStreetMap</p>
            </div>
          </div>
        </div>

        <div class="rounded-2xl border border-border-light bg-card-light shadow-sm dark:border-border-dark dark:bg-card-dark">
          <div class="border-b border-border-light px-4 py-3 dark:border-border-dark">
            <h4 class="text-sm font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-300">Transit History</h4>
          </div>
          <div class="space-y-4 p-4">
            {% for event in selected.events.all %}
            <div class="flex gap-3 rounded-xl border border-border-light px-3 py-3 dark:border-border-dark">
              <div class="mt-1 flex h-9 w-9 items-center justify-center rounded-full bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary">
                <span class="material-symbols-outlined text-base">{{ event.icon|default:"local_shipping" }}</span>
              </div>
              <div>
                <p class="text-sm font-semibold text-text-light dark:text-text-dark">{{ event.description }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  {{ event.location|default:"Location unavailable" }} &middot; {{ event.timestamp|date:"M j, Y, g:i A" }}
                </p>
              </div>
            </div>
            {% empty %}
            <p class="text-sm text-gray-500 dark:text-gray-400">No event updates recorded for this shipment yet.</p>
            {% endfor %}
          </div>
        </div>
      </div>
      {% else %}
      <div class="flex h-full items-center justify-center rounded-xl border border-dashed border-border-light bg-card-light/60 p-10 text-center text-gray-500 dark:border-border-dark dark:bg-card-dark/60">
        Select a shipment to view detailed tracking information.
      </div>
      {% endif %}
    </section>
  </div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
></script>
<script>
(function () {
  const mapContainer = document.getElementById("shipment-map");
  if (!mapContainer || typeof L === "undefined") {
    return;
  }

  const originLabel = "{{ selected.origin|escapejs }}";
  const destinationLabel = "{{ selected.destination|escapejs }}";

  const map = L.map(mapContainer, { zoomControl: false }).setView([20, 0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  function geocode(place) {
    if (!place) {
      return Promise.resolve(null);
    }
    const url =
      "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" +
      encodeURIComponent(place);
    return fetch(url, {
      headers: { "Accept-Language": "en" },
    })
      .then((response) => response.json())
      .then((data) => {
        if (!data || !data.length) return null;
        return {
          lat: parseFloat(data[0].lat),
          lon: parseFloat(data[0].lon),
          display: data[0].display_name || place,
        };
      })
      .catch(() => null);
  }

  Promise.all([geocode(originLabel), geocode(destinationLabel)]).then(
    ([originPoint, destinationPoint]) => {
      const fallbackOrigin = { lat: 40.7128, lon: -74.006 };
      const fallbackDestination = { lat: 34.0522, lon: -118.2437 };

      const origin = originPoint || fallbackOrigin;
      const destination = destinationPoint || fallbackDestination;

      const originMarker = L.marker([origin.lat, origin.lon], {
        title: originLabel,
      }).addTo(map);
      originMarker.bindPopup(
        `<strong>Origin</strong><br>${originPoint ? origin.display : originLabel}`
      );

      const destinationMarker = L.marker([destination.lat, destination.lon], {
        title: destinationLabel,
      }).addTo(map);
      destinationMarker.bindPopup(
        `<strong>Destination</strong><br>${
          destinationPoint ? destination.display : destinationLabel
        }`
      );

      const route = L.polyline(
        [
          [origin.lat, origin.lon],
          [destination.lat, destination.lon],
        ],
        { color: "#1173d4", weight: 3, opacity: 0.8, dashArray: "6 6" }
      ).addTo(map);

      map.fitBounds(route.getBounds(), { padding: [40, 40] });
    }
  );
})();
</script>
{% endblock %}
