{% extends "base.html" %}
{% block title %}Reports & Analytics - Logistics Pro{% endblock %}
{% block content %}
<div class="flex h-full flex-col gap-6 p-6 lg:p-10">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <h1 class="text-4xl font-black leading-tight tracking-[-0.033em] text-text-light dark:text-text-dark">Reports &amp; Analytics</h1>
    <div class="flex items-center gap-2">
      <button type="button" class="rounded-lg p-2 text-slate-500 hover:bg-slate-200 dark:text-slate-400 dark:hover:bg-slate-700">
        <span class="material-symbols-outlined">share</span>
      </button>
      <button type="button" class="rounded-lg p-2 text-slate-500 hover:bg-slate-200 dark:text-slate-400 dark:hover:bg-slate-700">
        <span class="material-symbols-outlined">save</span>
      </button>
      <button type="button" class="flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-bold leading-normal tracking-[0.015em] text-white">
        <span class="material-symbols-outlined text-base" style="font-variation-settings: 'FILL' 1;">download</span>
        <span class="truncate">Export</span>
      </button>
    </div>
  </div>

  <div class="grid gap-6 lg:grid-cols-4">
    <aside class="lg:col-span-1 self-start rounded-xl border border-[#cfdbe7] bg-white p-6 dark:border-slate-700 dark:bg-slate-900">
      <form method="get" class="flex flex-col gap-6">
        <div>
          <label for="report-type" class="mb-1 block text-sm font-medium text-slate-700 dark:text-slate-300">Report Type</label>
          <select id="report-type" name="report" class="w-full rounded-lg border-[#cfdbe7] bg-white text-slate-900 text-sm focus:border-primary focus:ring-primary dark:border-slate-600 dark:bg-slate-800 dark:text-slate-50">
            {% for report in report_types %}
            <option value="{{ report }}" {% if report == selected_report %}selected{% endif %}>{{ report }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="date-range" class="mb-1 block text-sm font-medium text-slate-700 dark:text-slate-300">Date</label>
          <input type="date" id="date-range" name="date" value="{{ selected_date }}" class="w-full rounded-lg border-[#cfdbe7] bg-white text-slate-900 text-sm focus:border-primary focus:ring-primary dark:border-slate-600 dark:bg-slate-800 dark:text-slate-50"/>
        </div>
        <div class="space-y-4">
          <h3 class="text-sm font-medium text-slate-700 dark:text-slate-300">Filters</h3>
          <div class="space-y-3">
            {% for filt in filters %}
            <label class="flex items-center gap-2 text-sm text-slate-900 dark:text-slate-100">
              <input type="checkbox" name="filter_{{ filt.key }}" {% if filt.checked %}checked{% endif %} class="h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary dark:border-slate-600 dark:bg-slate-800"/>
              {{ filt.label }}
            </label>
            {% endfor %}
          </div>
        </div>
        <button type="submit" class="flex h-10 items-center justify-center rounded-lg bg-primary px-4 text-sm font-bold tracking-[0.015em] text-white">Generate Report</button>
      </form>
    </aside>

    <section class="lg:col-span-3 flex flex-col gap-6">
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4">
        {% for metric in metrics %}
        <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl border border-[#cfdbe7] bg-white p-6 dark:border-slate-700 dark:bg-slate-900">
          <p class="text-base font-medium leading-normal text-slate-700 dark:text-slate-300">{{ metric.label }}</p>
          <p class="text-2xl font-bold leading-tight text-slate-900 dark:text-slate-50">{{ metric.value }}</p>
          {% if metric.trend|slice:":1" == "-" %}
          <p class="text-base font-medium leading-normal text-red-600 dark:text-red-500">{{ metric.trend }}</p>
          {% else %}
          <p class="text-base font-medium leading-normal text-green-600 dark:text-green-500">{{ metric.trend }}</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>

      <div class="rounded-xl border border-[#cfdbe7] bg-white dark:border-slate-700 dark:bg-slate-900">
        <div class="border-b border-[#cfdbe7] px-4 dark:border-slate-700">
          <nav role="tablist" aria-label="Report data views" class="flex gap-8" data-tablist>
            {% for tab in tabs %}
            {% with is_active=active_tab == tab.key %}
            <button
              type="submit"
              form="tab-query-form"
              name="tab"
              value="{{ tab.key }}"
              role="tab"
              id="tab-{{ tab.key }}"
              aria-controls="panel-{{ tab.key }}"
              aria-selected="{{ is_active|yesno:'true,false' }}"
              tabindex="{% if is_active %}0{% else %}-1{% endif %}"
              data-tab-target="{{ tab.key }}"
              data-active-class="border-b-primary text-slate-900 dark:text-slate-50"
              data-inactive-class="border-b-transparent text-slate-500 dark:text-slate-400"
              class="flex flex-col items-center justify-center border-b-[3px] pb-[13px] pt-4 text-sm font-bold leading-normal tracking-[0.015em] transition-colors {{ 'border-b-primary text-slate-900 dark:text-slate-50' if is_active else 'border-b-transparent text-slate-500 dark:text-slate-400' }}"
            >
              <span>{{ tab.label }}</span>
            </button>
            {% endwith %}
            {% endfor %}
          </nav>
          <form id="tab-query-form" method="get" class="hidden">
            {% for key, value in current_query_params.items %}
            <input type="hidden" name="{{ key }}" value="{{ value }}"/>
            {% endfor %}
          </form>
        </div>
        <div class="p-6">
          <div class="mb-4 flex flex-col gap-1">
            <h3 class="font-bold text-slate-900 dark:text-slate-50">{{ selected_report }}</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400">Performance over the selected period</p>
          </div>
          <div
            id="panel-visualizations"
            role="tabpanel"
            aria-labelledby="tab-visualizations"
            data-tab-panel="visualizations"
            {% if active_tab != 'visualizations' %}hidden{% endif %}
          >
            <div class="flex h-80 w-full items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-800">
              <img src="{{ chart_image }}" alt="Delivery performance chart" class="opacity-40 dark:invert"/>
            </div>
          </div>
          <div
            id="panel-raw"
            role="tabpanel"
            aria-labelledby="tab-raw"
            data-tab-panel="raw"
            {% if active_tab != 'raw' %}hidden{% endif %}
          >
            <div class="flex flex-col gap-4">
              <div class="flex items-center justify-between">
                <p class="text-sm font-medium text-slate-600 dark:text-slate-300">Download a CSV export of the current filters or review the latest shipment activity.</p>
                <a
                  href="#"
                  class="inline-flex items-center gap-2 rounded-lg border border-primary px-3 py-2 text-sm font-semibold text-primary transition hover:bg-primary hover:text-white focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                >
                  <span class="material-symbols-outlined text-base" style="font-variation-settings: 'FILL' 1;">file_download</span>
                  Export CSV
                </a>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 text-left text-sm text-slate-700 dark:divide-slate-700 dark:text-slate-200">
                  <thead class="bg-slate-50 dark:bg-slate-800">
                    <tr>
                      <th scope="col" class="px-4 py-3 font-semibold">Shipment ID</th>
                      <th scope="col" class="px-4 py-3 font-semibold">Status</th>
                      <th scope="col" class="px-4 py-3 font-semibold">Origin</th>
                      <th scope="col" class="px-4 py-3 font-semibold">Destination</th>
                      <th scope="col" class="px-4 py-3 font-semibold">Cost</th>
                      <th scope="col" class="px-4 py-3 font-semibold">Last Updated</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% for row in raw_data_records %}
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800">
                      <td class="px-4 py-3 font-semibold text-slate-900 dark:text-slate-100">{{ row.shipment_id }}</td>
                      <td class="px-4 py-3">{{ row.status }}</td>
                      <td class="px-4 py-3">{{ row.origin }}</td>
                      <td class="px-4 py-3">{{ row.destination }}</td>
                      <td class="px-4 py-3">{{ row.cost }}</td>
                      <td class="px-4 py-3">{{ row.updated }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="6" class="px-4 py-6 text-center text-slate-500 dark:text-slate-400">No raw data available for the current filters.</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>
<script>
  (function () {
    const tablist = document.querySelector('[data-tablist]');
    const tabForm = document.getElementById('tab-query-form');
    if (!tablist || !tabForm) {
      return;
    }

    const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
    const panels = Array.from(document.querySelectorAll('[data-tab-panel]'));

    function getParamsWithTab(tabKey) {
      const formData = new FormData(tabForm);
      formData.set('tab', tabKey);
      return new URLSearchParams(formData.entries());
    }

    function updateUrl(tabKey) {
      const params = getParamsWithTab(tabKey);
      const paramString = params.toString();
      const url = paramString ? `${window.location.pathname}?${paramString}` : window.location.pathname;
      window.history.replaceState(null, '', url);
    }

    function setActiveTab(tabKey, { focusTab = false, updateHistory = false } = {}) {
      tabs.forEach((tab) => {
        const isActive = tab.dataset.tabTarget === tabKey;
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
        tab.tabIndex = isActive ? 0 : -1;
        const activeClasses = tab.dataset.activeClass?.split(' ') ?? [];
        const inactiveClasses = tab.dataset.inactiveClass?.split(' ') ?? [];
        if (isActive) {
          tab.classList.add(...activeClasses);
          tab.classList.remove(...inactiveClasses);
        } else {
          tab.classList.add(...inactiveClasses);
          tab.classList.remove(...activeClasses);
        }
        if (focusTab && isActive) {
          tab.focus();
        }
      });

      panels.forEach((panel) => {
        if (panel.dataset.tabPanel === tabKey) {
          panel.removeAttribute('hidden');
        } else {
          panel.setAttribute('hidden', '');
        }
      });

      if (updateHistory) {
        updateUrl(tabKey);
      }
    }

    function handleClick(event) {
      const tab = event.currentTarget;
      const tabKey = tab.dataset.tabTarget;
      if (!tabKey) {
        return;
      }
      if (event.button !== 0 || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) {
        return;
      }
      event.preventDefault();
      setActiveTab(tabKey, { focusTab: true, updateHistory: true });
    }

    function handleKeydown(event) {
      const { key } = event;
      if (key !== 'ArrowLeft' && key !== 'ArrowRight') {
        return;
      }
      event.preventDefault();
      const currentIndex = tabs.indexOf(event.currentTarget);
      if (currentIndex === -1) {
        return;
      }
      const direction = key === 'ArrowRight' ? 1 : -1;
      const nextIndex = (currentIndex + direction + tabs.length) % tabs.length;
      const nextTab = tabs[nextIndex];
      setActiveTab(nextTab.dataset.tabTarget, { focusTab: true, updateHistory: true });
    }

    tabs.forEach((tab) => {
      tab.addEventListener('click', handleClick);
      tab.addEventListener('keydown', handleKeydown);
    });
  })();
</script>
{% endblock %}
